---
layout: nb-post
title: "Analyzing Churn Using the Survivor Model"
author: Alan Burke
github: 
tags: [Churn, Survivor Models]
---

<!--put these separators somewhere appropriate:-->

<!--you can set this to false if you want code displayed by default-->
<script>
hide_code=false;
</script>

<!--this is just hacky filler-->
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>
<hr>
</p>
</div>
</div>
</div>
<!--back to the good stuff-->

<div tabindex="-1" id="notebook" class="border-box-sizing">
<div class="container" id="notebook-container">

<!--if you've decided to show code by default, please reword the following-->
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>
NOTE: the code in this notebook can be hidden for better readability. To toggle on/off, click <a href="javascript:code_toggle()">here</a>.
</p>
</div>
</div>
</div>


<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Analyzing-Churn-Using-the-Survivor-Model">Analyzing Churn Using the Survivor Model<a class="anchor-link" href="#Analyzing-Churn-Using-the-Survivor-Model">&#182;</a></h1><h2 id="Alan-Burke">Alan Burke<a class="anchor-link" href="#Alan-Burke">&#182;</a></h2><p>March 23, 2016</p>
<!--excerpt.start-->
<p>I recently gave a talk at GDC on using the survivor model to identify casual factors in churn.  This post is to present the code I used in that presentation and is useful for individuals who would like to practice creating a survivor model.  Survivor models are popular for modeling single incidence events such as player churn.  Another popular use of survivor model is to analyze a player's first MTX purchase.</p>
<!--excerpt.end--><!--more-->
<h1 id="Scenario-1---New-Ad">Scenario 1 - New Ad<a class="anchor-link" href="#Scenario-1---New-Ad">&#182;</a></h1><p>Imagine a situation where your user acquisition team launched a new advertisement campaign.  They used a provocative ad that generates a lot of new users.  However, your game is free to play and you monetize steadily over the life of the player.  You want to use churn as a proxy for quality, since if the players don't stay in your game long enough, it is impossible to monetize on them.</p>
<p>The code below, when pasted into Excel, will create some sample data for the first scenario.  PLease paste for formula in at least 1000 rows so you have enough data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre>Random	Start	End	Churned	DaysPlayed	 Amazon 	Google	Other	PurchasePrice	FirstSessionLength
<span class="o">=</span>RAND<span class="p">()</span>	<span class="o">=</span>ROUND<span class="p">(</span>RAND<span class="p">()</span><span class="o">*</span><span class="m">5</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>	<span class="o">=</span>B2<span class="o">+</span>ROUND<span class="p">(</span>RAND<span class="p">()</span><span class="o">*</span><span class="m">10</span><span class="p">,</span><span class="m">0</span><span class="p">)</span><span class="m">+1</span>	<span class="o">=</span>IF<span class="p">((((</span>C2<span class="o">-</span>B2<span class="p">)</span><span class="o">^</span><span class="m">-2</span><span class="p">)</span><span class="o">*</span>A2<span class="p">)</span><span class="o">&lt;</span><span class="m">0.02</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>	<span class="o">=</span>C2<span class="o">-</span>B2	<span class="o">=</span>IF<span class="p">(</span><span class="m">0.5</span><span class="o">+</span>D2<span class="o">*</span><span class="m">0.25</span><span class="o">-</span>RAND<span class="p">()</span><span class="o">^</span><span class="m">0.5</span><span class="o">&lt;-</span><span class="m">0.15</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>	<span class="o">=</span>IF<span class="p">(</span>F2<span class="o">=</span><span class="m">0</span><span class="p">,</span>IF<span class="p">(</span><span class="m">0.5</span><span class="o">+</span>D2<span class="o">*</span><span class="m">0.25</span><span class="o">-</span>RAND<span class="p">()</span><span class="o">^</span><span class="m">0.5</span><span class="o">&lt;</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">),</span><span class="m">0</span><span class="p">)</span>	<span class="o">=</span>IF<span class="p">(</span>G2<span class="o">+</span>F2<span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>	<span class="o">=</span>ROUND<span class="p">((</span><span class="m">0.25</span><span class="o">-</span>D2<span class="o">*</span><span class="m">0.25</span><span class="o">+</span>RAND<span class="p">()</span><span class="o">^</span><span class="m">0.3</span><span class="p">)</span><span class="o">*</span><span class="m">50</span><span class="p">,</span><span class="m">-1</span><span class="p">)</span>	<span class="o">=</span>ROUND<span class="p">((</span><span class="m">0.5</span><span class="o">-</span>D2<span class="o">*</span><span class="m">0.5+3</span><span class="o">*</span><span class="p">(</span>RAND<span class="p">()</span><span class="o">^</span><span class="m">0.5</span><span class="p">))</span><span class="o">*</span><span class="m">50</span><span class="p">,</span><span class="m">0</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since all numbers where generated without a set seed, I include the actual values used in this analysis below.  In constructing this dataset, each row represents one player.</p>
<p>The next piece is to run the R code to generate the survivor model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span class="c1"># Read in your data</span>
churn <span class="o">&lt;-</span> read.csv<span class="p">(</span><span class="s">&quot;path_to_your_data/Ad Data.csv&quot;</span><span class="p">)</span>
<span class="c1"># Attaching allows you to refer to your data with shorthand</span>
<span class="kn">attach</span><span class="p">(</span>churn<span class="p">)</span>
<span class="c1"># Initialize the survival library.  This steps assumes you have already install the library</span>
<span class="kn">library</span><span class="p">(</span><span class="s">&quot;survival&quot;</span><span class="p">)</span>

<span class="c1"># Please see the survival library documentation for a full reference off all the survival functions</span>
<span class="c1"># Here we calculate the incident of churn each day from the number of players that are still active</span>
churn.surv <span class="o">&lt;-</span> survfit<span class="p">(</span>Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span><span class="o">~</span> <span class="m">1</span><span class="p">,</span> conf.type<span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">)</span>
<span class="kp">summary</span><span class="p">(</span>churn.surv<span class="p">)</span>
<span class="c1"># Plotting survival probability</span>
plot<span class="p">(</span>churn.surv<span class="p">,</span> xlab<span class="o">=</span><span class="s">&quot;DaysPlayed&quot;</span><span class="p">,</span> ylab<span class="o">=</span><span class="s">&quot;Survival Probability&quot;</span><span class="p">)</span>

<span class="c1"># The first churn model uses the exponential distribution</span>
churn.survexp <span class="o">&lt;-</span> survreg<span class="p">(</span>Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> Amazon<span class="o">+</span>Google<span class="o">+</span>FirstSessionLength<span class="o">+</span>PurchasePrice<span class="p">,</span> dist<span class="o">=</span><span class="s">&quot;exponential&quot;</span><span class="p">)</span>
<span class="kp">summary</span><span class="p">(</span>churn.survexp<span class="p">)</span>

<span class="c1"># The second churn model uses the weibull distribution</span>
churn.survWeibull <span class="o">&lt;-</span> survreg<span class="p">(</span>Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> Amazon<span class="o">+</span>Google<span class="o">+</span>FirstSessionLength<span class="o">+</span>PurchasePrice<span class="p">,</span> dist<span class="o">=</span><span class="s">&quot;weibull&quot;</span><span class="p">)</span>
<span class="kp">summary</span><span class="p">(</span>churn.survWeibull<span class="p">)</span>

<span class="kn">library</span><span class="p">(</span>lmtest<span class="p">)</span>
<span class="c1"># The test results show that the models are stastically different and the weibull fits the data better</span>
lrtest<span class="p">(</span>churn.survexp<span class="p">,</span>churn.survWeibull<span class="p">)</span>

<span class="c1"># clean up</span>
<span class="kn">detach</span><span class="p">(</span>churn<span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here is the condensed output from the above code.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre>survfit<span class="p">(</span>formula <span class="o">=</span> Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> <span class="m">1</span><span class="p">,</span> conf.type <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">)</span>

 time n.risk n.event survival  std.err
    <span class="m">1</span> <span class="m">104856</span>      <span class="m">98</span>    <span class="m">0.999</span> <span class="m">9.44e-05</span>
    <span class="m">2</span>  <span class="m">99529</span>     <span class="m">846</span>    <span class="m">0.991</span> <span class="m">3.05e-04</span>
    <span class="m">3</span>  <span class="m">89208</span>    <span class="m">1854</span>    <span class="m">0.970</span> <span class="m">5.60e-04</span>
    <span class="m">4</span>  <span class="m">78741</span>    <span class="m">3382</span>    <span class="m">0.928</span> <span class="m">8.82e-04</span>
    <span class="m">5</span>  <span class="m">68210</span>    <span class="m">5222</span>    <span class="m">0.857</span> <span class="m">1.25e-03</span>
    <span class="m">6</span>  <span class="m">57770</span>    <span class="m">7564</span>    <span class="m">0.745</span> <span class="m">1.62e-03</span>
    <span class="m">7</span>  <span class="m">47249</span>   <span class="m">10480</span>    <span class="m">0.580</span> <span class="m">1.90e-03</span>
    <span class="m">8</span>  <span class="m">36573</span>   <span class="m">10386</span>    <span class="m">0.415</span> <span class="m">1.93e-03</span>
    <span class="m">9</span>  <span class="m">26187</span>   <span class="m">10372</span>    <span class="m">0.251</span> <span class="m">1.71e-03</span>
   <span class="m">10</span>  <span class="m">15815</span>   <span class="m">10514</span>    <span class="m">0.084</span> <span class="m">1.10e-03</span>
   <span class="m">11</span>   <span class="m">5301</span>    <span class="m">5301</span>    <span class="m">0.000</span>      <span class="kc">NaN</span>
   

survreg<span class="p">(</span>formula <span class="o">=</span> Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> Amazon <span class="o">+</span> Google <span class="o">+</span> 
    FirstSessionLength <span class="o">+</span> PurchasePrice<span class="p">,</span> dist <span class="o">=</span> <span class="s">&quot;exponential&quot;</span><span class="p">)</span>
                     Value Std. Error    z         p
<span class="p">(</span>Intercept<span class="p">)</span>        <span class="m">1.18025</span>   <span class="m">0.017063</span> <span class="m">69.2</span>  <span class="m">0.00e+00</span>
Amazon             <span class="m">0.40787</span>   <span class="m">0.010726</span> <span class="m">38.0</span>  <span class="m">0.00e+00</span>
Google             <span class="m">0.11250</span>   <span class="m">0.008739</span> <span class="m">12.9</span>  <span class="m">6.32e-38</span>
FirstSessionLength <span class="m">0.00272</span>   <span class="m">0.000105</span> <span class="m">25.9</span> <span class="m">1.44e-147</span>
PurchasePrice      <span class="m">0.01661</span>   <span class="m">0.000351</span> <span class="m">47.3</span>  <span class="m">0.00e+00</span>

Scale fixed at <span class="m">1</span> 

Exponential distribution
Loglik<span class="p">(</span>model<span class="p">)</span><span class="o">=</span> <span class="m">-212158.6</span>   Loglik<span class="p">(</span>intercept only<span class="p">)</span><span class="o">=</span> <span class="m">-214884.3</span>
	Chisq<span class="o">=</span> <span class="m">5451.41</span> on <span class="m">4</span> degrees of freedom<span class="p">,</span> p<span class="o">=</span> <span class="m">0</span> 
Number of Newton<span class="o">-</span>Raphson Iterations<span class="o">:</span> <span class="m">4</span> 
n<span class="o">=</span> <span class="m">104856</span> 


survreg<span class="p">(</span>formula <span class="o">=</span> Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> Amazon <span class="o">+</span> Google <span class="o">+</span> 
    FirstSessionLength <span class="o">+</span> PurchasePrice<span class="p">,</span> dist <span class="o">=</span> <span class="s">&quot;weibull&quot;</span><span class="p">)</span>
                       Value Std. Error       z        p
<span class="p">(</span>Intercept<span class="p">)</span>         <span class="m">2.098805</span>   <span class="m">4.50e-03</span>  <span class="m">466.85</span> <span class="m">0.00e+00</span>
Amazon              <span class="m">0.012933</span>   <span class="m">2.48e-03</span>    <span class="m">5.21</span> <span class="m">1.84e-07</span>
Google              <span class="m">0.003131</span>   <span class="m">2.03e-03</span>    <span class="m">1.54</span> <span class="m">1.24e-01</span>
FirstSessionLength  <span class="m">0.000143</span>   <span class="m">2.54e-05</span>    <span class="m">5.62</span> <span class="m">1.95e-08</span>
PurchasePrice       <span class="m">0.000690</span>   <span class="m">9.01e-05</span>    <span class="m">7.65</span> <span class="m">1.96e-14</span>
Log<span class="p">(</span><span class="kp">scale</span><span class="p">)</span>         <span class="m">-1.456626</span>   <span class="m">3.02e-03</span> <span class="m">-482.26</span> <span class="m">0.00e+00</span>

Scale<span class="o">=</span> <span class="m">0.233</span> 

Weibull distribution
Loglik<span class="p">(</span>model<span class="p">)</span><span class="o">=</span> <span class="m">-146039.7</span>   Loglik<span class="p">(</span>intercept only<span class="p">)</span><span class="o">=</span> <span class="m">-146101</span>
	Chisq<span class="o">=</span> <span class="m">122.62</span> on <span class="m">4</span> degrees of freedom<span class="p">,</span> p<span class="o">=</span> <span class="m">0</span> 
Number of Newton<span class="o">-</span>Raphson Iterations<span class="o">:</span> <span class="m">15</span> 
n<span class="o">=</span> <span class="m">104856</span> 


lrtest<span class="p">(</span>churn.survexp<span class="p">,</span>churn.survWeibull<span class="p">)</span>

Likelihood ratio test
Model <span class="m">1</span><span class="o">:</span> Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> Amazon <span class="o">+</span> Google <span class="o">+</span> FirstSessionLength <span class="o">+</span> 
    PurchasePrice
Model <span class="m">2</span><span class="o">:</span> Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> Amazon <span class="o">+</span> Google <span class="o">+</span> FirstSessionLength <span class="o">+</span> 
    PurchasePrice
  <span class="c1">#Df  LogLik Df  Chisq Pr(&gt;Chisq)    </span>
<span class="m">1</span>   <span class="m">5</span> <span class="m">-212159</span>                         
<span class="m">2</span>   <span class="m">6</span> <span class="m">-146040</span>  <span class="m">1</span> <span class="m">132238</span>  <span class="o">&lt;</span> <span class="m">2.2e-16</span> <span class="o">***</span>
<span class="o">---</span>
Signif. codes<span class="o">:</span>  <span class="m">0</span> ‘<span class="o">***</span>’ <span class="m">0.001</span> ‘<span class="o">**</span>’ <span class="m">0.01</span> ‘<span class="o">*</span>’ <span class="m">0.05</span> ‘<span class="m">.</span>’ <span class="m">0.1</span> ‘ ’ <span class="m">1</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By comparing the two models, we can see that they are stastically different and the weibull distribution fits the data better.  Now that we have identified our game data as having a weibull distribution in churn, let's analyze the effect of the new ad.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span class="c1"># Read in the ad data</span>
cyborg <span class="o">&lt;-</span> read.csv<span class="p">(</span><span class="s">&quot;path_to_your_data//Churn Data with Cyborg Campaign.csv&quot;</span><span class="p">)</span>
<span class="kn">attach</span><span class="p">(</span>cyborg<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span><span class="s">&quot;survival&quot;</span><span class="p">)</span>

<span class="c1"># Run the weibull model again, but with the added CyborgAd variable</span>
cyborg.survWeibull <span class="o">&lt;-</span> survreg<span class="p">(</span>Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> CyborgAd<span class="o">+</span> Amazon<span class="o">+</span>Google<span class="o">+</span>FirstSessionLength<span class="o">+</span>PurchasePrice<span class="p">,</span> dist<span class="o">=</span><span class="s">&quot;weibull&quot;</span><span class="p">)</span>
<span class="kp">summary</span><span class="p">(</span>cyborg.survWeibull<span class="p">)</span>

<span class="kn">detach</span><span class="p">(</span>cyborg<span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With the following condensed output:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre>survreg<span class="p">(</span>formula <span class="o">=</span> Surv<span class="p">(</span>DaysPlayed<span class="p">,</span> Churned<span class="p">)</span> <span class="o">~</span> CyborgAd <span class="o">+</span> Amazon <span class="o">+</span> 
    Google <span class="o">+</span> FirstSessionLength <span class="o">+</span> PurchasePrice<span class="p">,</span> dist <span class="o">=</span> <span class="s">&quot;weibull&quot;</span><span class="p">)</span>
                       Value Std. Error       z        p
<span class="p">(</span>Intercept<span class="p">)</span>         <span class="m">2.098137</span>   <span class="m">5.33e-03</span>  <span class="m">393.98</span> <span class="m">0.00e+00</span>
CyborgAd           <span class="m">-0.095127</span>   <span class="m">2.12e-03</span>  <span class="m">-44.81</span> <span class="m">0.00e+00</span>
Amazon              <span class="m">0.012497</span>   <span class="m">2.85e-03</span>    <span class="m">4.39</span> <span class="m">1.12e-05</span>
Google             <span class="m">-0.002237</span>   <span class="m">2.33e-03</span>   <span class="m">-0.96</span> <span class="m">3.37e-01</span>
FirstSessionLength  <span class="m">0.000121</span>   <span class="m">2.94e-05</span>    <span class="m">4.11</span> <span class="m">3.91e-05</span>
PurchasePrice       <span class="m">0.000502</span>   <span class="m">1.03e-04</span>    <span class="m">4.88</span> <span class="m">1.08e-06</span>
Log<span class="p">(</span><span class="kp">scale</span><span class="p">)</span>         <span class="m">-1.233473</span>   <span class="m">2.82e-03</span> <span class="m">-437.16</span> <span class="m">0.00e+00</span>

Scale<span class="o">=</span> <span class="m">0.291</span> 

Weibull distribution
Loglik<span class="p">(</span>model<span class="p">)</span><span class="o">=</span> <span class="m">-180633.5</span>   Loglik<span class="p">(</span>intercept only<span class="p">)</span><span class="o">=</span> <span class="m">-181713.9</span>
	Chisq<span class="o">=</span> <span class="m">2160.92</span> on <span class="m">5</span> degrees of freedom<span class="p">,</span> p<span class="o">=</span> <span class="m">0</span> 
Number of Newton<span class="o">-</span>Raphson Iterations<span class="o">:</span> <span class="m">11</span> 
n<span class="o">=</span> <span class="m">104856</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here, negative coefficients indicate an increased likelihood to churn.  The results show that although the Cyborg ad had a solid acquisition rate, the players did not retain as well.  To calculate whether the campaign itself was profitable, you would have to look at your monetization of players with the shorter duration of play and compare it to your acquisition costs.</p>
<h1 id="Scenario-2---Patching-a-Title">Scenario 2 - Patching a Title<a class="anchor-link" href="#Scenario-2---Patching-a-Title">&#182;</a></h1><p>The premise of the second scenario is that the game is patched.  The patch makes these changes:</p>
<ul>
<li>the patch goes live on day 4 to 50% of the player base</li>
<li>it includes a critical bug fix</li>
<li>it has a UI change to make warriors more prominient</li>
<li>it includes an update to the graphics</li>
</ul>

<p>Unbeknownst to the developers, the patch also includes a critical bug that only affects wizards.</p>
<p>Here is the SQL code used to generate the random data.  The SQL code uses window analytic functions and should run in systems using PostgreSQL style syntax.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span class="o">/*</span> A rough order of operations <span class="kr">for</span> how the code runs<span class="o">:</span>
Create a table of random variables.
Apply player specific qualitities based on those stats<span class="p">,</span> such as which class they choose.
Create daily specific variables<span class="p">,</span> including some additional random variables such as whether they had a bug that day.
Calculate when a player churns.  Since this is fake data<span class="p">,</span> a player can <span class="s">&quot;churn&quot;</span> multiple times.  
To correct the fake data<span class="p">,</span> anyone marked as churned has all data truncated after their first churn flag using window functions
<span class="o">*/</span>


drop table <span class="kr">if</span> exists schema_name_here.churn_test_model<span class="p">;</span>

<span class="o">--</span> create a permanent <span class="kp">table</span>
create table schema_name_here.churn_test_model as <span class="p">(</span>
select start<span class="p">,</span> <span class="kp">stop</span><span class="p">,</span> age_of_account<span class="p">,</span> patch<span class="p">,</span> bug<span class="p">,</span> minutes_played<span class="p">,</span> is_wizard<span class="p">,</span> churn<span class="p">,</span> patch_group<span class="p">,</span> quit_seed<span class="p">,</span> test<span class="p">,</span> bug_seed
from
	<span class="o">--</span> select the first time a player churns
    <span class="p">(</span>select <span class="o">*</span>
        <span class="p">,</span> lag<span class="p">(</span>churn<span class="p">)</span> over <span class="p">(</span>partition by quit_seed order by age_of_account<span class="p">)</span> as lag_churn
    from
		<span class="o">--</span> ordering the data by individual player churn
        <span class="p">(</span>select start<span class="p">,</span> <span class="kp">stop</span><span class="p">,</span> age_of_account<span class="p">,</span> patch<span class="p">,</span> bug<span class="p">,</span> minutes_played<span class="p">,</span> quit_seed<span class="p">,</span> patch_group<span class="p">,</span> is_wizard<span class="p">,</span> test<span class="p">,</span> bug_seed
            <span class="p">,</span> <span class="kp">max</span><span class="p">(</span>churn<span class="p">)</span> over <span class="p">(</span>partition by quit_seed order by quit_seed<span class="p">,</span> age_of_account desc range between current row and unbounded following<span class="p">)</span> as churn
        from
			<span class="o">--</span> calculate when the player churns
            <span class="p">(</span>select <span class="o">*</span>
            <span class="p">,</span> <span class="o">-</span><span class="kp">log</span><span class="p">(</span>age_of_account<span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="m">0.5</span><span class="o">+</span>ln<span class="p">(</span>minutes_played<span class="p">)</span><span class="o">/</span><span class="m">20</span><span class="o">+</span><span class="p">(</span><span class="o">@</span>quit_seed<span class="p">)</span><span class="o">/</span><span class="m">4</span><span class="o">+</span>patch<span class="o">*</span><span class="m">0.025</span><span class="o">+</span>random_noise<span class="o">/</span><span class="m">6</span><span class="o">-</span>bug<span class="o">*</span><span class="m">0.12</span><span class="o">-</span>is_wizard<span class="o">*</span>patch<span class="o">*</span><span class="m">0.04</span> as test
            <span class="p">,</span> case when <span class="o">-</span><span class="kp">log</span><span class="p">(</span>age_of_account<span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="m">0.5</span><span class="o">+</span>ln<span class="p">(</span>minutes_played<span class="p">)</span><span class="o">/</span><span class="m">20</span><span class="o">+</span><span class="p">(</span><span class="o">@</span>quit_seed<span class="p">)</span><span class="o">/</span><span class="m">4</span><span class="o">+</span>patch<span class="o">*</span><span class="m">0.025</span><span class="o">+</span>random_noise<span class="o">/</span><span class="m">6</span><span class="o">-</span>bug<span class="o">*</span><span class="m">0.12</span><span class="o">-</span>is_wizard<span class="o">*</span>patch<span class="o">*</span><span class="m">0.04</span><span class="o">&lt;</span><span class="m">0</span> then <span class="m">1</span> <span class="kr">else</span> <span class="m">0</span> end as churn
             from
				<span class="o">--</span> add <span class="kr">in</span> daily bugs
                <span class="p">(</span>select <span class="o">*</span>
                    <span class="o">--</span> bugs vary depending on patch and <span class="kp">class</span>
                    <span class="p">,</span> case when class<span class="o">=</span><span class="m">2</span> then <span class="m">1</span> <span class="kr">else</span> <span class="m">0</span> end as is_wizard
                    <span class="p">,</span> case when bug_seed<span class="o">&gt;</span><span class="m">.9</span> and patch<span class="o">=</span><span class="m">0</span> then <span class="m">1</span> 
                        when bug_seed<span class="o">&gt;</span><span class="m">.85</span> and patch<span class="o">=</span><span class="m">1</span> and class<span class="o">=</span><span class="m">2</span> then <span class="m">1</span>
                        when bug_seed<span class="o">&gt;</span><span class="m">.95</span> and patch<span class="o">=</span><span class="m">1</span> and class<span class="o">=</span><span class="m">1</span> then <span class="m">1</span>
                        <span class="kr">else</span> <span class="m">0</span> end as bug
                    <span class="o">--</span> time played varies on bug chance
                    <span class="p">,</span> case when bug_seed<span class="o">&gt;</span><span class="m">.9</span> and patch<span class="o">=</span><span class="m">0</span> then <span class="o">@</span>minutes_played_seed<span class="o">*</span><span class="m">15</span>
                        when bug_seed<span class="o">&gt;</span><span class="m">.85</span> and patch<span class="o">=</span><span class="m">1</span> and class<span class="o">=</span><span class="m">2</span> then <span class="o">@</span>minutes_played_seed<span class="o">*</span><span class="m">15</span>
                        when bug_seed<span class="o">&gt;</span><span class="m">.95</span> and patch<span class="o">=</span><span class="m">1</span> and class<span class="o">=</span><span class="m">1</span> then <span class="o">@</span>minutes_played_seed<span class="o">*</span><span class="m">15</span>
                        <span class="kr">else</span> <span class="o">@</span>minutes_played_seed<span class="o">*</span><span class="m">20</span> end as minutes_played
                from 
					<span class="o">--</span> start creating the daily variables
                    <span class="p">(</span>select <span class="o">*</span> 
                        <span class="p">,</span> start_date<span class="o">+</span>age_of_account as start
                        <span class="p">,</span> start_date<span class="o">+</span>age_of_account<span class="m">+1</span> as <span class="kp">stop</span>
                        <span class="p">,</span> random<span class="p">()</span> as bug_seed
                        <span class="p">,</span> random<span class="p">()</span><span class="o">+</span>random<span class="p">()</span><span class="o">*</span>random<span class="p">()</span><span class="m">-3</span> minutes_played_seed 
                        <span class="p">,</span> case when patch_seed<span class="o">&gt;=</span><span class="m">.5</span> and start_date<span class="o">+</span>age_of_account<span class="o">&gt;</span><span class="m">3</span> then <span class="m">1</span>
                            <span class="kr">else</span> <span class="m">0</span> end as patch
                        <span class="p">,</span> <span class="p">(</span>random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>    random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>    random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>
                                    random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span><span class="m">-6</span><span class="p">)</span><span class="o">/</span><span class="m">4</span> as random_noise  <span class="o">--</span> make the daily calculations have noise
                    from
						<span class="o">--</span> create the player specific data
                        <span class="p">(</span>select <span class="o">*</span>
                            <span class="p">,</span> <span class="kp">trunc</span><span class="p">(</span>start_date_seed<span class="o">*</span><span class="m">8</span><span class="p">)</span> as start_date
                            <span class="p">,</span> case when start_date_seed<span class="o">*</span><span class="m">8</span><span class="o">&lt;</span><span class="m">3</span> and class_seed <span class="o">&lt;</span><span class="m">.6</span> then <span class="m">1</span> <span class="o">--</span> warrior<span class="p">,</span> pre patch
                                when start_date_seed<span class="o">*</span><span class="m">8</span><span class="o">&lt;</span><span class="m">3</span> then <span class="m">2</span> <span class="o">--</span> wizard<span class="p">,</span> pre patch 
                                when class_seed<span class="o">&lt;</span><span class="m">.6</span> and patch_seed<span class="o">&lt;</span><span class="m">.5</span> then <span class="m">1</span> <span class="o">--</span> warrior<span class="p">,</span> no patch
                                when patch_seed<span class="o">&lt;</span><span class="m">.5</span> then <span class="m">2</span> <span class="o">--</span> wizard<span class="p">,</span> no patch
                                when class_seed <span class="o">&lt;</span><span class="m">.8</span> then <span class="m">1</span>  <span class="o">--</span> warrior<span class="p">,</span> patch 
                                <span class="kr">else</span> <span class="m">2</span> <span class="o">--</span> wizard<span class="p">,</span> patch
                                end as <span class="kp">class</span>
                            <span class="p">,</span> case when patch_seed<span class="o">&gt;=</span><span class="m">.5</span> then <span class="m">1</span>
                            <span class="kr">else</span> <span class="m">0</span> end as patch_group
                        from
							<span class="o">--</span> create a set of random numbers to build the data set
                            <span class="p">(</span>select setseed<span class="p">(</span><span class="m">0</span><span class="p">)</span> as null_seed<span class="p">,</span> null as quit_seed<span class="p">,</span> null as start_date_seed<span class="p">,</span> null as class_seed<span class="p">,</span> null as patch_seed
                            union <span class="kp">all</span>
                            select null
                                <span class="p">,</span> random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>    random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>    random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>
                                    random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span> <span class="o">+</span>     random<span class="p">()</span><span class="m">-6</span> 
                                <span class="p">,</span> random<span class="p">()</span>
                                <span class="p">,</span> random<span class="p">()</span> 
                                <span class="p">,</span> random<span class="p">()</span>
                            from generate_series<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">100000</span><span class="p">)</span>
                            offset <span class="m">1</span><span class="p">)</span> as random_sequence
                        <span class="p">)</span> as seed_values
                    cross join
                        <span class="p">(</span>select row_number<span class="p">()</span> over<span class="p">()</span> as age_of_account
                        from generate_series<span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">))</span> as study_days
                    <span class="p">)</span> as random_day
                <span class="p">)</span> as day_event
            <span class="p">)</span> as input_variable
        <span class="p">)</span> as done
    <span class="p">)</span> as limiting
where <span class="p">(</span>lag_churn<span class="o">&lt;&gt;</span><span class="m">1</span> or lag_churn is null<span class="p">)</span> and <span class="kp">stop</span><span class="o">&lt;=</span><span class="m">10</span>
<span class="p">)</span>
<span class="p">;</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This code generates a random set of data for our model.  The actual data used can be at the bottom of this post.  Notice that each day of data is its own row, and the quit_seed variable actually functions as the player id.  The data is organized similar to a panel dataset.</p>
<p>Here is the R code used to run the model:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre><span class="kn">library</span><span class="p">(</span>RODBC<span class="p">)</span>

myconn<span class="o">&lt;-</span>odbcConnect<span class="p">(</span><span class="s">&#39;This_is_your_odbc_connection&#39;</span><span class="p">)</span>

patch_data <span class="o">=</span>  sqlQuery<span class="p">(</span>myconn<span class="p">,</span><span class="s">&quot;select * from schema_name_here.churn_test_model&quot;</span><span class="p">)</span>

<span class="kn">attach</span><span class="p">(</span>patch_data<span class="p">)</span>

<span class="kp">summary</span><span class="p">(</span>coxph<span class="p">(</span>Surv<span class="p">(</span>start<span class="p">,</span> <span class="kp">stop</span><span class="p">,</span> churn<span class="p">)</span> <span class="o">~</span> bug<span class="o">+</span>is_wizard<span class="o">+</span>patch<span class="o">+</span>age_of_account<span class="o">+</span>minutes_played<span class="o">+</span>cluster<span class="p">(</span>quit_seed<span class="p">),</span> data<span class="o">=</span>patch_data<span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The results of the code can be found here:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre>coxph<span class="p">(</span>formula <span class="o">=</span> Surv<span class="p">(</span>start<span class="p">,</span> <span class="kp">stop</span><span class="p">,</span> churn<span class="p">)</span> <span class="o">~</span> bug <span class="o">+</span> is_wizard <span class="o">+</span> 
    patch <span class="o">+</span> age_of_account <span class="o">+</span> minutes_played <span class="o">+</span> cluster<span class="p">(</span>quit_seed<span class="p">),</span> 
    data <span class="o">=</span> patch_data<span class="p">)</span>

  n<span class="o">=</span> <span class="m">382440</span><span class="p">,</span> number of events<span class="o">=</span> <span class="m">59227</span> 

                     coef  <span class="kp">exp</span><span class="p">(</span>coef<span class="p">)</span>   se<span class="p">(</span>coef<span class="p">)</span>  robust se       z Pr<span class="p">(</span><span class="o">&gt;|</span>z<span class="o">|</span><span class="p">)</span>    
bug             <span class="m">1.3921964</span>  <span class="m">4.0236780</span>  <span class="m">0.0112569</span>  <span class="m">0.0110634</span> <span class="m">125.838</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
is_wizard       <span class="m">0.0830510</span>  <span class="m">1.0865972</span>  <span class="m">0.0086099</span>  <span class="m">0.0092643</span>   <span class="m">8.965</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
patch          <span class="m">-0.0828029</span>  <span class="m">0.9205325</span>  <span class="m">0.0089436</span>  <span class="m">0.0094945</span>  <span class="m">-8.721</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
age_of_account  <span class="m">0.1582036</span>  <span class="m">1.1714047</span>  <span class="m">0.0023148</span>  <span class="m">0.0024072</span>  <span class="m">65.720</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
minutes_played <span class="m">-0.0196435</span>  <span class="m">0.9805482</span>  <span class="m">0.0005978</span>  <span class="m">0.0005983</span> <span class="m">-32.832</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here, positive coefficients indicate a higher likelihood to churn.  The initial results show that the patch reduces churn.  However, in the forums, customer service reports an increased number of complaints from wizards.  Forums are notoriously hard to extropolate to the entire player community, so instead, let's use the survivor model to see what is happening with wizards and the patch by creating an interaction variable.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre>patch_data<span class="o">$</span>wizard_bug <span class="o">&lt;-</span> is_wizard<span class="o">*</span>bug

<span class="kp">summary</span><span class="p">(</span>coxph<span class="p">(</span>Surv<span class="p">(</span>start<span class="p">,</span> <span class="kp">stop</span><span class="p">,</span> churn<span class="p">)</span> <span class="o">~</span> 
    bug<span class="o">+</span>is_wizard<span class="o">+</span>patch<span class="o">+</span>age_of_account<span class="o">+</span>minutes_played<span class="o">+</span>wizard_patch<span class="o">+</span>cluster<span class="p">(</span>quit_seed<span class="p">),</span> data<span class="o">=</span>patch_data<span class="p">))</span>

<span class="kn">detach</span><span class="p">(</span>patch_data<span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The formula stays the same except for the addition of the new variable, wizard_patch.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div></div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-r"><pre>coxph<span class="p">(</span>formula <span class="o">=</span> Surv<span class="p">(</span>start<span class="p">,</span> <span class="kp">stop</span><span class="p">,</span> churn<span class="p">)</span> <span class="o">~</span> bug <span class="o">+</span> is_wizard <span class="o">+</span> 
    patch <span class="o">+</span> age_of_account <span class="o">+</span> minutes_played <span class="o">+</span> wizard_patch <span class="o">+</span> 
    cluster<span class="p">(</span>quit_seed<span class="p">),</span> data <span class="o">=</span> patch_data<span class="p">)</span>

  n<span class="o">=</span> <span class="m">382440</span><span class="p">,</span> number of events<span class="o">=</span> <span class="m">59227</span> 

                     coef  <span class="kp">exp</span><span class="p">(</span>coef<span class="p">)</span>   se<span class="p">(</span>coef<span class="p">)</span>  robust se       z Pr<span class="p">(</span><span class="o">&gt;|</span>z<span class="o">|</span><span class="p">)</span>    
bug             <span class="m">1.3777800</span>  <span class="m">3.9660871</span>  <span class="m">0.0113080</span>  <span class="m">0.0111103</span> <span class="m">124.009</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
is_wizard      <span class="m">-0.0054967</span>  <span class="m">0.9945184</span>  <span class="m">0.0109240</span>  <span class="m">0.0115514</span>  <span class="m">-0.476</span>    <span class="m">0.634</span>    
patch          <span class="m">-0.1666453</span>  <span class="m">0.8464998</span>  <span class="m">0.0109573</span>  <span class="m">0.0112832</span> <span class="m">-14.769</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
age_of_account  <span class="m">0.1560963</span>  <span class="m">1.1689388</span>  <span class="m">0.0023195</span>  <span class="m">0.0024141</span>  <span class="m">64.659</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
minutes_played <span class="m">-0.0196420</span>  <span class="m">0.9805496</span>  <span class="m">0.0005978</span>  <span class="m">0.0005983</span> <span class="m">-32.830</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
wizard_patch    <span class="m">0.2353473</span>  <span class="m">1.2653481</span>  <span class="m">0.0176368</span>  <span class="m">0.0188478</span>  <span class="m">12.487</span>   <span class="o">&lt;</span><span class="m">2e-16</span> <span class="o">***</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div>
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When you separate out wizards who receive the patch, you find that they had increased likelihood to churn due to the increased incidence in bugs.</p>
<h1 id="Summary">Summary<a class="anchor-link" href="#Summary">&#182;</a></h1><p>While the examples used in this blog are trivial, they are useful for showing how the survival model can fit single incidence events with non-normal distributions such as churn quite well.  Feeding the data into the model is straight forward and in the modelling stage, you have a lot of flexibility in what variables you include.  Ideally, you'd have some sort of experiment running to give you clear causation, but even correlations can help you understand how different factors relate to each other.</p>

</div>
</div>
</div>
</div>
</div>
